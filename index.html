<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fun X — Space (Full)</title>
<style>
/* ====== CSS مبسّط ومركّز للنسخة المتكاملة ====== */
:root{
  --bg1:#000014; --bg2:#001431; --accent:#6ffcff; --ui:#0b1220;
  --glass: rgba(255,255,255,0.04);
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,Segoe UI}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6f0f6;overflow:hidden}
#gameCanvas{display:block;width:100vw;height:100vh;background:transparent}
.ui {
  position: absolute; left: 12px; top: 12px; z-index: 50;
  background: rgba(0,0,0,0.45); padding: 10px; border-radius: 8px; border:1px solid rgba(255,255,255,0.04);
}
.ui h1{margin:0;font-size:16px}
.controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
button,select,input[type=range]{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;padding:6px;border-radius:6px}
.badge{font-size:12px;color:#9fb3c8;margin-top:6px}
#hpBar{position:absolute;left:50%;top:12px;transform:translateX(-50%);width:260px;height:18px;border-radius:12px;border:2px solid rgba(255,255,255,0.12);background:#111;z-index:50}
#hpFill{width:100%;height:100%;background:linear-gradient(90deg,#0f0,#ff0,#f00);border-radius:8px;transition:width 0.18s}
#overlayUI{position:absolute;right:12px;bottom:12px;z-index:50;color:#9fb3c8}
#gameOverScreen, #shopModal, #missionModal, #dailyModal {
  position: absolute; left:50%; top:50%; transform: translate(-50%,-50%); z-index: 100;
  background: rgba(3,6,12,0.82); padding: 22px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);
  display:none; min-width:320px; text-align:center;
}
.modalTitle{font-size:20px;margin-bottom:8px}
.row{display:flex;gap:8px;align-items:center}
.toggle{display:inline-flex;align-items:center;gap:6px}
.hudSmall{font-size:13px;color:#cfeff0;margin-top:6px}
.joy{
  position: absolute; left: 18px; bottom: 18px; z-index: 60; width:140px; height:140px; border-radius:12px;
  background: rgba(255,255,255,0.02); display:flex;align-items:center;justify-content:center; touch-action:none;
}
.joy .dot{width:38px;height:38px;border-radius:10px;background:rgba(255,255,255,0.06)}
.fireBtn{
  position:absolute; right:18px; bottom:18px; z-index:60; width:88px;height:88px;border-radius:50%;
  background: linear-gradient(180deg, rgba(255,80,80,0.15), rgba(255,30,30,0.12)); display:flex;align-items:center;justify-content:center;
  font-weight:700; font-size:18px; touch-action:none;
}
.small{font-size:12px;color:#9fb3c8}
.icon{width:18px;height:18px;display:inline-block;border-radius:4px;background:var(--accent);opacity:0.9;margin-left:6px}
.settingRow{display:flex;justify-content:space-between;gap:8px;margin-top:8px;align-items:center}
.footerNote{position:absolute;left:50%;bottom:8px;transform:translateX(-50%);color:#9fb3c8;font-size:12px;z-index:40}
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<!-- UI -->
<div class="ui" id="mainUI">
  <h1>Fun X — Space</h1>
  <div class="controls">
    <button id="startBtn">ابدأ</button>
    <button id="pauseBtn">إيقاف</button>
    <button id="retryBtn">إعادة</button>
    <div class="toggle small"><label><input type="checkbox" id="autoFire"> Auto-Fire</label></div>
    <div class="toggle small"><label><input type="checkbox" id="freeAim"> Free Aim</label></div>
    <button id="shopBtn">المتجر</button>
    <button id="missionsBtn">المهام</button>
  </div>
  <div class="badge">دراعات متصلة: <span id="gpList">—</span></div>
  <div class="hudSmall">نقاط: <span id="scoreEl">0</span> — مستوى: <span id="levelEl">1</span></div>
</div>

<div id="hpBar"><div id="hpFill"></div></div>
<div id="overlayUI" class="small">نصيحة: اضغط على الشاشة لتفعيل الصوت إذا لم تعمل الأصوات</div>

<!-- Touch controls -->
<div class="joy" id="joy" style="display:none"><div class="dot" id="joyDot"></div></div>
<div class="fireBtn" id="fireBtn" style="display:none">أ</div>

<!-- Modals -->
<div id="gameOverScreen"><div class="modalTitle">Game Over</div><div id="finalScore">نقاطك: 0</div><div style="margin-top:12px"><button id="tryAgain">إعادة المحاولة</button></div></div>

<div id="shopModal">
  <div class="modalTitle">المتجر & الترقيات</div>
  <div class="small">نقاط متاحة: <span id="shopScore">0</span></div>
  <div style="margin-top:10px" id="shopItems"></div>
  <div style="margin-top:12px"><button id="closeShop">اغلاق</button></div>
</div>

<div id="missionModal">
  <div class="modalTitle">المهام</div>
  <div id="missionBody" class="small"></div>
  <div style="margin-top:12px"><button id="closeMission">اغلاق</button></div>
</div>

<div id="dailyModal">
  <div class="modalTitle">مكافأة اليوم</div>
  <div id="dailyBody" class="small"></div>
  <div style="margin-top:12px"><button id="closeDaily">اغلاق</button></div>
</div>

<div class="footerNote">تصميم سريع — أخبرني بأي تعديل تريده</div>

<script>
/* ======================= JavaScript: اللعبة الكاملة (بروتوتايب) ======================= */
/* ملاحظات:
 - هذه نسخة متقدمة ومتكاملة داخل صفحة واحده.
 - تحفظ الترقيات وHighScore وDailyReward باستخدام localStorage.
 - تدعم أي Gamepad متصل؛ وتدعم لاعب ثاني عند توصيل دراع/استخدام ازرار بديلة.
*/

// ------ إعداد كانفاس وواجهة صوتية بسيطة ------
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
addEventListener('resize', resize); resize();

// WebAudio بسيط للمؤثرات
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new AudioContext(); if(audioCtx.state === 'suspended') audioCtx.resume(); }

// مؤثرات صوتية صغيرة
function beep(freq, t=0.06, type='sine', vol=0.08){
  try{ ensureAudio(); const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + t);
  }catch(e){/*ignore*/}}
function shootSound(){ beep(900,0.06,'square',0.06); }
function explodeSound(){ beep(120,0.25,'sawtooth',0.16); setTimeout(()=>beep(60,0.12,'sine',0.06),70); }
function pickupSound(){ beep(1400,0.06,'triangle',0.06); }

// ------ حالة اللعبة الأساسية ------
let running = false;
let paused = false;
let score = 0;
let level = 1;
let highScore = parseInt(localStorage.getItem('fx_high')) || 0;
let upgrades = JSON.parse(localStorage.getItem('fx_upgrades')||'{}');
if(!upgrades.speed) upgrades = {speed:0, power:0, shots:0, shield:0};
let lastDaily = localStorage.getItem('fx_daily') || null;
document.getElementById('scoreEl').textContent = score;
document.getElementById('levelEl').textContent = level;

// لعبة العناصر
let player1 = null, player2 = null; // objects or null
let npcs = []; // حلفاء
let bullets = [], enemies = [], pickups = [], explosions = [];
let stars = [];
for(let i=0;i<250;i++) stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, z:Math.random()*1.6+0.2, s:Math.random()*2+0.2});

// إعداد HP bar
const hpFill = document.getElementById('hpFill');
function updateHPBar(){
  if(player1) hpFill.style.width = Math.max(0, (player1.hp/ (player1.maxHp) )*100) + '%';
}

// ------ Input: Keyboard, touch joystick, gamepad ------
const input = { p1:{left:0,right:0,up:0,down:0,action:0,aimX:null,aimY:null,auto:false},
                p2:{left:0,right:0,up:0,down:0,action:0,aimX:null,aimY:null,auto:false}};
document.getElementById('autoFire').addEventListener('change', e=>{ input.p1.auto = e.target.checked; input.p2.auto = e.target.checked; });
document.getElementById('freeAim').addEventListener('change', e=>{ freeAim = e.target.checked; });

let freeAim = false;

// لوحة المفاتيح
window.addEventListener('keydown', e=>{
  // p1: أسهم أو WASD
  if(e.code==='ArrowLeft' || e.code==='KeyA') input.p1.left=1;
  if(e.code==='ArrowRight'|| e.code==='KeyD') input.p1.right=1;
  if(e.code==='ArrowUp' || e.code==='KeyW') input.p1.up=1;
  if(e.code==='ArrowDown'|| e.code==='KeyS') input.p1.down=1;
  if(e.code==='Space') input.p1.action=1;
  // مفاتيح لاعب ثاني (التي قد يستخدمها لاعب2 على نفس لوحة مفاتيح)
  if(e.code==='KeyJ') input.p2.left=1;
  if(e.code==='KeyL') input.p2.right=1;
  if(e.code==='KeyI') input.p2.up=1;
  if(e.code==='KeyK') input.p2.down=1;
  if(e.code==='Enter') input.p2.action=1;
});
window.addEventListener('keyup', e=>{
  if(e.code==='ArrowLeft' || e.code==='KeyA') input.p1.left=0;
  if(e.code==='ArrowRight'|| e.code==='KeyD') input.p1.right=0;
  if(e.code==='ArrowUp' || e.code==='KeyW') input.p1.up=0;
  if(e.code==='ArrowDown'|| e.code==='KeyS') input.p1.down=0;
  if(e.code==='Space') input.p1.action=0;
  if(e.code==='KeyJ') input.p2.left=0;
  if(e.code==='KeyL') input.p2.right=0;
  if(e.code==='KeyI') input.p2.up=0;
  if(e.code==='KeyK') input.p2.down=0;
  if(e.code==='Enter') input.p2.action=0;
});

// Touch joystick
const joy = document.getElementById('joy'), joyDot = document.getElementById('joyDot'), fireBtn = document.getElementById('fireBtn');
let touchEnabled = false;
function enableTouchUI(){
  touchEnabled = true;
  joy.style.display = 'block';
  fireBtn.style.display = 'block';
}
function disableTouchUI(){ touchEnabled=false; joy.style.display='none'; fireBtn.style.display='none'; }
let activeTouchId = null, joyCenter = null;
function joyGetCenter(){ const r = joy.getBoundingClientRect(); return {x: r.left + r.width/2, y: r.top + r.height/2}; }
joy.addEventListener('pointerdown', e=>{ joy.setPointerCapture(e.pointerId); activeTouchId=e.pointerId; joyCenter=joyGetCenter(); handleJoyMove(e.clientX,e.clientY); });
joy.addEventListener('pointermove', e=>{ if(e.pointerId!==activeTouchId) return; handleJoyMove(e.clientX,e.clientY); });
joy.addEventListener('pointerup', e=>{ if(e.pointerId!==activeTouchId) return; activeTouchId=null; joyDot.style.transform='translate(0,0)'; input.p1.left=input.p1.right=input.p1.up=input.p1.down=0; });
function handleJoyMove(cx,cy){
  const dx = cx - joyCenter.x, dy = cy - joyCenter.y; const max=34;
  const nx = Math.max(-max, Math.min(max, dx)); const ny = Math.max(-max, Math.min(max, dy));
  joyDot.style.transform = `translate(${nx}px,${ny}px)`;
  input.p1.left = nx < -12 ? 1 : 0; input.p1.right = nx > 12 ? 1 : 0; input.p1.up = ny < -12 ? 1 : 0; input.p1.down = ny > 12 ? 1 : 0;
}
fireBtn.addEventListener('pointerdown', ()=>{ input.p1.action=1; setTimeout(()=>input.p1.action=0,120); });

// detect touch to show joystick
window.addEventListener('touchstart', e=>{ enableTouchUI(); ensureAudio(); }, {passive:true});

// Gamepad support
let gpListEl = document.getElementById('gpList');
let gamepads = {};
function scanGamepads(){
  const gps = navigator.getGamepads ? navigator.getGamepads() : [];
  let names = [];
  for(let g of gps) if(g) { names.push(g.id); gamepads[g.index]=g; }
  gpListEl.textContent = names.length ? names.join(' | ') : '—';
}
window.addEventListener('gamepadconnected', e=>{ scanGamepads(); });
window.addEventListener('gamepaddisconnected', e=>{ scanGamepads(); });

// poll gamepads each frame
function pollGamepads(){
  const gps = navigator.getGamepads ? navigator.getGamepads() : [];
  // map first connected to p2 if exists, and also allow its axes to control movement
  for(let i=0;i<gps.length;i++){
    const g = gps[i]; if(!g) continue;
    // choose mapping simple: left stick axes 0/1 for movement, button0 for shoot
    const axH = g.axes[0]||0, axV = g.axes[1]||0;
    // assign to player2 if player2 exists, otherwise to player1
    const target = player2 ? input.p2 : input.p1;
    target.left = axH < -0.3 ? 1 : 0;
    target.right = axH > 0.3 ? 1 : 0;
    target.up = axV < -0.3 ? 1 : 0;
    target.down = axV > 0.3 ? 1 : 0;
    // any button -> action
    if(g.buttons.some(b=>b.pressed)) { target.action = 1; } else { target.action = 0; }
    // vibration on explosion is triggered elsewhere using playEffect if supported
  }
}

// ------ Entities constructors ------
function makePlayer(x,y, color='#7efcff'){
  const baseSpeed = 220 + (upgrades.speed||0)*20;
  const p = {
    id: 'p'+(Math.random()*1000|0),
    x:x, y:y, size:44, color:color,
    speed: baseSpeed,
    hp: 3 + (upgrades.shield||0),
    maxHp: 3 + (upgrades.shield||0),
    fireCooldown:0,
    weapon: {type:'laser', power: 1 + (upgrades.power||0), shots: 1 + (upgrades.shots||0)}
  };
  return p;
}

function makeNPC(x,y){
  return {id:'npc'+(Math.random()*1000|0), x,y, size:36, color:'#88f', speed:140, hp:2, fireCooldown:0};
}

// ------ Spawn helpers ------
function spawnEnemyWave(rngCount){
  const count = rngCount || (3 + Math.min(12, level + (Math.random()*3|0)));
  for(let i=0;i<count;i++){
    const t = Math.random();
    const e = {
      id:'e'+(Math.random()*9999|0),
      x: Math.random()*(canvas.width-80)+40,
      y: -Math.random()*200 - 60*i,
      w: t<0.6 ? 34 : (t<0.9? 60:48),
      h: t<0.6 ? 34 : (t<0.9? 44:48),
      color: t<0.6? '#ff6b6b' : (t<0.9? '#ff4d4d' : '#ffb86b'),
      hp: t<0.6?1:(t<0.9?3:2),
      speed: 40 + (Math.random()*60) + level*8,
      type: t<0.6? 'scout' : (t<0.9? 'heavy':'fast')
    };
    enemies.push(e);
  }
}

// Power-ups
function spawnPickup(x,y){
  const types = ['score','speed','shield','fireRate','weapon'];
  const p = { id:'p'+(Math.random()*9999|0), x,y, r:10, type: types[Math.random()*types.length|0] };
  pickups.push(p);
}

// ------ AI behaviors (بساطة ولكن فعالة) ------
function enemyAI(e, dt){
  // choose nearest player or npc
  const targets = [player1].concat(player2? [player2]:[]).concat(npcs);
  let best=null, bestd=1e9;
  for(let t of targets) if(t){
    const dx = t.x - e.x, dy = t.y - e.y;
    const d = Math.hypot(dx,dy);
    if(d < bestd){ best = t; bestd = d; }
  }
  if(best){
    // behavior by type
    if(e.type==='scout'){
      // chase but try to avoid bullets: if bullet near, pick perpendicular vector
      let avoid = false;
      for(let b of bullets){
        const db = Math.hypot(b.x - e.x, b.y - e.y);
        if(db < 80){ avoid = true; break; }
      }
      if(avoid){
        // move sideways
        e.x += (Math.random()>0.5?1:-1) * e.speed * dt * 0.6;
      } else {
        // chase
        const ang = Math.atan2(best.y - e.y, best.x - e.x);
        e.x += Math.cos(ang) * e.speed * dt;
        e.y += Math.sin(ang) * e.speed * dt;
      }
    } else if(e.type==='fast'){
      // dart towards player
      const ang = Math.atan2(best.y - e.y, best.x - e.x);
      e.x += Math.cos(ang) * e.speed * dt * 1.1;
      e.y += Math.sin(ang) * e.speed * dt * 1.1;
    } else {
      // heavy - slow, try to lead shots (simple)
      const ang = Math.atan2(best.y - e.y, best.x - e.x);
      e.x += Math.cos(ang) * e.speed * dt * 0.6;
      e.y += Math.sin(ang) * e.speed * dt * 0.6;
    }
  }
}

// NPC ally behavior: follow nearest player and shoot enemies
function npcAI(n, dt){
  const target = player1 || player2;
  if(!target) return;
  // follow at offset
  const desiredX = target.x - 100;
  n.x += (desiredX - n.x) * dt * 2;
  n.y += (target.y - 50 - n.y) * dt * 2;
  // shoot nearest enemy if any
  if(n.fireCooldown <= 0){
    const en = enemies.length ? enemies[0] : null;
    if(en){
      bullets.push({x: n.x, y: n.y, vx: (en.x - n.x)*0.01, vy:(en.y - n.y)*0.01, speed: 320, friendly:true});
      n.fireCooldown = 40;
      shootSound();
    }
  } else n.fireCooldown--;
}

// ------ update loop ------
let lastTs = performance.now();
let spawnTimer = 0;
let waveInterval = 5; // seconds between waves (will be decreased with level)
function updateFrame(ts){
  const dt = Math.min(0.05, (ts - lastTs)/1000);
  lastTs = ts;
  if(!running || paused){ requestAnimationFrame(updateFrame); return; }

  // poll gamepads
  pollGamepads();

  // update stars (parallax)
  for(let s of stars){ s.y += 30 * dt * s.z; if(s.y > canvas.height) { s.y = -2; s.x = Math.random()*canvas.width; } }

  // players init
  if(!player1) player1 = makePlayer(canvas.width/2, canvas.height - 140, '#7efcff');
  if(!player2 && (/* if there is a second input */ false)) player2 = makePlayer(canvas.width/3, canvas.height - 140, '#ffc16f');

  // movement players
  if(player1){
    let vx = (input.p1.right - input.p1.left);
    let vy = (input.p1.down - input.p1.up);
    if(vx !== 0 || vy !== 0){
      const len = Math.hypot(vx, vy) || 1;
      player1.x += (vx/len) * player1.speed * dt;
      player1.y += (vy/len) * player1.speed * dt;
      player1.x = Math.max(player1.size/2, Math.min(canvas.width - player1.size/2, player1.x));
      player1.y = Math.max(player1.size/2, Math.min(canvas.height - player1.size/2, player1.y));
    }
    // auto-fire
    if((input.p1.action || input.p1.auto) && player1.fireCooldown<=0){
      fireFrom(player1);
      player1.fireCooldown = Math.max(6, 18 - (upgrades.fireRate||0));
    }
    if(player1.fireCooldown>0) player1.fireCooldown--;
  }

  if(player2){
    let vx2 = (input.p2.right - input.p2.left);
    let vy2 = (input.p2.down - input.p2.up);
    if(vx2 !== 0 || vy2 !== 0){
      const len = Math.hypot(vx2, vy2) || 1;
      player2.x += (vx2/len) * player2.speed * dt;
      player2.y += (vy2/len) * player2.speed * dt;
    }
    if((input.p2.action || input.p2.auto) && player2.fireCooldown<=0){
      fireFrom(player2); player2.fireCooldown = Math.max(10, 20 - (upgrades.fireRate||0));
    }
    if(player2.fireCooldown>0) player2.fireCooldown--;
  }

  // npc AI
  for(let n of npcs) npcAI(n, dt);

  // update bullets (friendly and enemy)
  for(let i=bullets.length-1;i>=0;i--){
    const b = bullets[i];
    if(b.vx) b.x += b.vx * 60 * dt;
    if(b.vy) b.y += b.vy * 60 * dt;
    else b.y -= b.speed * dt;
    // remove if offscreen
    if(b.y < -50 || b.y > canvas.height + 50 || b.x < -200 || b.x > canvas.width + 200) bullets.splice(i,1);
  }

  // enemies update + AI
  for(let i=enemies.length-1;i>=0;i--){
    const e = enemies[i];
    enemyAI(e, dt);
    // check collisions with bullets
    for(let j=bullets.length-1;j>=0;j--){
      const b = bullets[j];
      if(b.friendly && rectOverlap(b, e)){
        e.hp--; bullets.splice(j,1);
        if(e.hp<=0){
          explodeSound(); spawnPickup(e.x + e.w/2, e.y + e.h/2);
          enemies.splice(i,1);
          score += 100;
          document.getElementById('scoreEl').textContent = score;
          if(score > highScore){ highScore = score; localStorage.setItem('fx_high', highScore); }
        }
        break;
      }
    }
    // collision with player1
    if(player1 && rectOverlap(player1,e)){
      hitPlayer(player1); enemies.splice(i,1); continue;
    }
    // remove off screen
    if(e.y > canvas.height + 120 || e.x < -120 || e.x > canvas.width + 120) enemies.splice(i,1);
  }

  // pickups update & collect
  for(let i=pickups.length-1;i>=0;i--){
    const p = pickups[i];
    p.y += 80 * dt;
    if(player1 && dist(player1.x, player1.y, p.x, p.y) < 48){ applyPickup(player1,p); pickups.splice(i,1); pickupSound(); continue; }
    if(player2 && dist(player2.x, player2.y, p.x, p.y) < 48){ applyPickup(player2,p); pickups.splice(i,1); pickupSound(); continue; }
    if(p.y > canvas.height+60) pickups.splice(i,1);
  }

  // explosions animate
  for(let i=explosions.length-1;i>=0;i--){
    explosions[i].r += 120 * dt;
    if(explosions[i].r > 120) explosions.splice(i,1);
  }

  // spawn waves
  spawnTimer += dt;
  if(spawnTimer > Math.max(1.2, waveInterval - Math.min(1.0, level*0.05))){
    spawnEnemyWave();
    spawnTimer = 0;
    level = 1 + Math.floor(score / 1000);
    document.getElementById('levelEl').textContent = level;
  }

  // update HP UI
  updateHPBar();

  // check game over
  if(player1 && player1.hp <= 0){
    running = false; showGameOver(); // stop loop
  }

  // rendering
  renderAll();
  requestAnimationFrame(updateFrame);
}

// ------ helper functions ------
function dist(a,b,c,d){ return Math.hypot((a-c),(b-d)); }
function rectOverlap(a,b){
  const aw = a.w || a.size, ah = a.h || a.size;
  const bx = b.x, by = b.y, bw = b.w||b.size, bh=b.h||b.size;
  return (a.x - aw/2) < (bx + bw/2) && (a.x + aw/2) > (bx - bw/2) && (a.y - ah/2) < (by + bh/2) && (a.y + ah/2) > (by - bh/2);
}
function hitPlayer(p){
  p.hp -= 1;
  // screen shake & flash
  triggerShake(8, 200);
  explodeSound();
  // rumble gamepads
  const gps = navigator.getGamepads ? navigator.getGamepads() : [];
  for(let g of gps) if(g && g.vibrationActuator) try{ g.vibrationActuator.playEffect('dual-rumble',{duration:120, strongMagnitude:0.7, weakMagnitude:0.5}); } catch(e){}
  updateHPBar();
}

// firing helper
function fireFrom(p){
  // weapon types
  const w = p.weapon || {type:'laser', power:1, shots:1};
  if(w.type==='laser'){
    // single or multi-shot
    if(w.shots <= 1){
      bullets.push({x:p.x, y:p.y - p.size/1.3, w:8, h:14, speed: 420, friendly:true});
    } else {
      const spread = (w.shots-1)*6;
      for(let i=0;i<w.shots;i++){
        const off = -spread/2 + i*6;
        bullets.push({x:p.x + off, y:p.y - p.size/1.3, w:8, h:14, speed:420, friendly:true});
      }
    }
    shootSound();
  } else if(w.type==='missile'){
    bullets.push({x:p.x, y:p.y - p.size/1.3, w:10, h:20, vx:0, vy:0, speed:340, homing:true, friendly:true});
    shootSound();
  }
}

// apply pickup
function applyPickup(player, p){
  if(p.type==='score'){ score += 250; document.getElementById('scoreEl').textContent = score; }
  else if(p.type==='speed'){ upgrades.speed = (upgrades.speed||0) + 1; localStorage.setItem('fx_upgrades', JSON.stringify(upgrades)); }
  else if(p.type==='shield'){ player.hp = Math.min(player.maxHp, player.hp + 1); }
  else if(p.type==='fireRate'){ upgrades.fireRate = (upgrades.fireRate||0) + 1; localStorage.setItem('fx_upgrades', JSON.stringify(upgrades)); }
  else if(p.type==='weapon'){ player.weapon = {type: 'missile', power:2, shots:1}; }
}

// spawn helper for NPC
function spawnNPC(){
  npcs.push(makeNPC(player1.x - 100, player1.y - 50));
}

// distance helper already defined as dist()

// ------ render function ------
let shake = {x:0,y:0,time:0};
function triggerShake(strength=6, duration=160){
  shake.x = (Math.random()*2-1)*strength;
  shake.y = (Math.random()*2-1)*strength;
  shake.time = duration;
}
function renderAll(){
  // apply screen shake
  if(shake.time > 0){ shake.time -= 16; } else { shake.x=0; shake.y=0; }
  ctx.save();
  ctx.translate(shake.x, shake.y);

  // background gradient
  const g = ctx.createLinearGradient(0,0,0,canvas.height); g.addColorStop(0,'#001028'); g.addColorStop(1,'#000014');
  ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);

  // starfield (parallax)
  for(let s of stars){
    ctx.fillStyle = 'rgba(255,255,255,' + Math.min(1, s.z*0.6) +')';
    ctx.fillRect(s.x, s.y, s.s, s.s);
  }

  // enemies
  for(let e of enemies){ ctx.fillStyle = e.color; ctx.fillRect(e.x - e.w/2, e.y - e.h/2, e.w, e.h); }

  // pickups
  for(let p of pickups){
    ctx.fillStyle = (p.type==='score'? '#ffd86b' : p.type==='weapon'? '#6ffcff' : '#9ae66b');
    ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
  }

  // bullets
  for(let b of bullets){ ctx.fillStyle = b.color || '#ffd86b'; ctx.fillRect(b.x - (b.w||6)/2, b.y - (b.h||12)/2, b.w||6, b.h||12); }

  // explosions
  for(let ex of explosions){
    const a = Math.max(0, 1 - ex.r/120);
    ctx.beginPath(); ctx.fillStyle = 'rgba(255,150,60,'+a+')'; ctx.arc(ex.x, ex.y, ex.r, 0, Math.PI*2); ctx.fill();
  }

  // npcs
  for(let n of npcs){ ctx.fillStyle = n.color; ctx.fillRect(n.x - n.size/2, n.y - n.size/2, n.size, n.size); }

  // player
  if(player1){
    drawShip(player1.x, player1.y, player1.size, player1.color);
  }
  if(player2) drawShip(player2.x, player2.y, player2.size, player2.color);

  // HUD overlay (score done in top UI)
  ctx.restore();
}

// simple ship drawing with glow
function drawShip(x,y,size,color){
  ctx.save();
  ctx.fillStyle = color; ctx.shadowColor = color; ctx.shadowBlur = 20;
  ctx.beginPath(); ctx.moveTo(x, y - size/1.4); ctx.lineTo(x - size/1.8, y + size/1.8); ctx.lineTo(x + size/1.8, y + size/1.8); ctx.closePath();
  ctx.fill();
  ctx.restore();
}

// ------ Game control buttons ------
document.getElementById('startBtn').addEventListener('click', ()=>{ ensureAudio(); running=true; paused=false; lastTs = performance.now(); requestAnimationFrame(updateFrame); engineHumStart(); });
document.getElementById('pauseBtn').addEventListener('click', ()=>{ paused = !paused; if(paused) engineHumStop(); else engineHumStart(); });
document.getElementById('retryBtn').addEventListener('click', ()=>{ location.reload(); });
document.getElementById('tryAgain').addEventListener('click', ()=>{ document.getElementById('gameOverScreen').style.display='none'; resetGame(); });

// ------ Shop modal (ترقيات) ------
const shopModal = document.getElementById('shopModal');
document.getElementById('shopBtn').addEventListener('click', ()=>{ openShop(); });
document.getElementById('closeShop').addEventListener('click', ()=>{ shopModal.style.display='none'; });
function openShop(){
  document.getElementById('shopScore').textContent = score;
  const cont = document.getElementById('shopItems'); cont.innerHTML = '';
  const items = [
    {id:'speed',title:'سرعة السفينة +1', cost:500, apply: ()=>{ upgrades.speed=(upgrades.speed||0)+1; localStorage.setItem('fx_upgrades', JSON.stringify(upgrades)); }},
    {id:'power',title:'قوة السلاح +1', cost:700, apply: ()=>{ upgrades.power=(upgrades.power||0)+1; localStorage.setItem('fx_upgrades', JSON.stringify(upgrades)); }},
    {id:'shots',title:'عدد الطلقات +1', cost:900, apply: ()=>{ upgrades.shots=(upgrades.shots||0)+1; localStorage.setItem('fx_upgrades', JSON.stringify(upgrades)); }},
    {id:'shield',title:'زيادة درع +1', cost:600, apply: ()=>{ upgrades.shield=(upgrades.shield||0)+1; localStorage.setItem('fx_upgrades', JSON.stringify(upgrades)); }}
  ];
  for(let it of items){
    const d = document.createElement('div'); d.className='settingRow';
    d.innerHTML = `<div>${it.title}</div><div><button data-id="${it.id}">شراء ${it.cost}</button></div>`;
    cont.appendChild(d);
    d.querySelector('button').addEventListener('click', ()=>{
      if(score >= it.cost){ score -= it.cost; document.getElementById('scoreEl').textContent = score; it.apply(); alert('تم الشراء'); } else alert('نقاط غير كافية');
    });
  }
  shopModal.style.display='block';
  document.getElementById('shopScore').textContent = score;
}

// ------ Missions modal (مهمات بسيطة) ------
document.getElementById('missionsBtn').addEventListener('click', ()=>{ openMissions(); });
document.getElementById('closeMission').addEventListener('click', ()=>{ document.getElementById('missionModal').style.display='none'; });
function openMissions(){
  const body = document.getElementById('missionBody');
  body.innerHTML = '<div>مهمة اليوم: اهزم 10 أعداء في موجة واحدة</div><div style="margin-top:8px">مكافأة: 300 نقطة</div>';
  document.getElementById('missionModal').style.display='block';
}

// ------ Daily reward modal ------
document.getElementById('closeDaily').addEventListener('click', ()=>{ document.getElementById('dailyModal').style.display='none'; });
function checkDaily(){
  const today = (new Date()).toISOString().slice(0,10);
  if(lastDaily !== today){
    lastDaily = today; localStorage.setItem('fx_daily', lastDaily);
    score += 200; document.getElementById('scoreEl').textContent = score;
    document.getElementById('dailyBody').textContent = 'مكافأة يومية: 200 نقطة';
    document.getElementById('dailyModal').style.display='block';
  }
}
checkDaily();

// ------ Engine hum (صوت محرك بسيط) ------
let engineOsc=null, engineGain=null;
function engineHumStart(){
  try{ ensureAudio(); if(engineOsc) return;
    engineOsc = audioCtx.createOscillator(); engineGain = audioCtx.createGain();
    engineOsc.type='sine'; engineOsc.frequency.value = 60; engineGain.gain.value = 0.02;
    engineOsc.connect(engineGain); engineGain.connect(audioCtx.destination); engineOsc.start();
  }catch(e){}
}
function engineHumStop(){ try{ if(engineOsc){ engineOsc.stop(); engineOsc=null; engineGain=null; } }catch(e){} }

// ------ game over and reset ------
function showGameOver(){
  document.getElementById('finalScore').textContent = 'نقاطك: ' + score + ' — أعلى: ' + highScore;
  document.getElementById('gameOverScreen').style.display = 'block';
  engineHumStop();
}
function resetGame(){
  // clear arrays and stats but keep upgrades
  bullets = []; enemies = []; pickups = []; explosions = []; npcs=[];
  player1 = null; player2 = null;
  score = 0; level = 1; document.getElementById('scoreEl').textContent = score;
  running = true; paused=false; lastTs = performance.now();
  document.getElementById('gameOverScreen').style.display='none';
  requestAnimationFrame(updateFrame);
}

// ------ util: spawn initial NPC helper ------
spawnNPC();

// start an initial wave small
spawnEnemyWave(4);

// start loop paused - waiting user to press start
renderAll(); // initial draw

/* =========== ملاحظات إضافية ===========
 - هذه نسخة متقدمة ولكن يمكن تحسينها: إضافة مؤثرات صوتية حقيقية، sprites، وسلوك AI أعمق.
 - لتحويلها لتطبيق Android (APK) أنصح استخدام Godot أو الجمع داخل WebView مع TWA/Capacitor.
 - لو تحب أحط ملفات صوتية (wav/ogg) بدل المولدات، أرفعها وسأدرجها.
======================================= */
</script>
</body>
</html>
